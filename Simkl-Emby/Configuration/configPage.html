<!DOCTYPE html>
<html>
<head>
    <title>Simkl</title>
    <script type="text/javascript" src="SimklAPILogin.js"></script>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage" id="SimklConfigurationPage" data-require="emby-button,emby-checkbox,emby-input">
        <div data-role="content">
            <div class="content-primary">
                <form id="SimklConfigurationForm">
                    <h1>Log In</h1>
                    <div id="notLoggedIn" hidden>
                        <h2 id="loginMsg">You are not logged in</h2>
                        <!-- TODO: Style this -->
                        <h3 id="loginPin"></h3>
                    </div>
                    <div id="loggedIn" hidden>
                        <button id="logOutButton" is="emby-button" type="button" class="raised block"><span>Log Out</span></button>
                    </div>
                    <h1>Scrobbling Options</h1>
                    <div class="checkboxContainer">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="autoscrobble" />
                            <span>Enable autoscrobbling</span>
                        </label>
                    </div>

                    <div class="checkboxContainer">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="bubble" />
                            <span>Show bubble while scrobbling</span>
                        </label>
                    </div>

                    <div class="inputContainer">
                        <input is="emby-input" id="scr_pct" type="number" min="0" max="100" pattern="[0-9]*" label="Scrobbling percentage:" />
                        <div class="fieldDescription">
                            Percentage watched needed to scrobble
                        </div>
                    </div>

                    <div class="inputContainer">
                        <input is="emby-input" id="min_length" type="number" min="0" max="60" pattern="[0-9]*" label="Min length:" />
                        <div class="fieldDescription">
                            Length needed (in minutes) for a clip to be scrobbled. This way, short videos and trailers won't be scrobbled
                        </div>
                    </div>
                    <br />
                    <br />
                    <button is="emby-button" type="submit" class="raised button-submit block"><span>${ButtonSave}</span></button>
                    <button is="emby-button" type="button" onclick="history.back();" class="raised block"><span>${ButtonCancel}</span></button>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var guid = "2ecd91d5-b14b-4b92-8eb9-52c098edfc87";

            var SimklAPI = {
                auth_pending:false,
                user_code:"",
                interval: 5,
                timeout: 500,
                access_token: "",
                getCode: function () {
                    // var uri = ApiClient._serverAddress + "/Simkl/oauth/pin";
                    var uri = "/Simkl/oauth/pin";
                    var request = new XMLHttpRequest();

                    console.log("Getting " + uri);
                    request.open("GET", uri, false);
                    request.send();

                    console.log("Status: " + request.status);
                    console.log("Response: " + request.response);
                    var response = $.parseJSON(request.response);
                    this.user_code = response.user_code;
                    this.interval = response.interval + 1;
                    this.timeout = response.expires_in;
                    this.auth_pending = true;

                    return request.status == 200;
                },
                checkCodeStatus: function (obj) {
                    if (document.hasFocus()) {
                        if (!obj.auth_pending || new Date() > obj.finish) clearInterval(obj.chkCodeInterval);
                        else {
                            var uri = "/Simkl/oauth/pin/" + obj.user_code;
                            var r = new XMLHttpRequest();
                            r.open("GET", uri, false);
                            console.log("Getting " + uri);
                            r.send();   // Request sent

                            if (r.status == 200) {
                                var response = $.parseJSON(r.response);
                                obj.access_token = response.access_token;
                                obj.auth_pending = response.message == "Authorization pending";
                                console.log("Checking code status " + JSON.stringify(obj));
                                console.log("Response: " + JSON.stringify(response));

                                if(response.result == "OK") obj.setCodeInConfig();
                            }
                        }
                    }
                },
                setCodeInConfig: function () {
                    ApiClient.getPluginConfiguration(guid).then(function (config) {
                        config.userToken = SimklAPI.access_token;

                        ApiClient.updatePluginConfiguration(guid, config); //.then(Dashboard.processPluginConfigurationUpdateResult);
                    });
                },
                logIn: async function (div_id) {
                    this.getCode();
                    this.finish = new Date();
                    this.finish.setSeconds(this.finish.getSeconds() + this.timeout - 5 * this.interval)

                    $(div_id).html(this.user_code);
                    console.log("this: " + JSON.stringify(this));
                    this.chkCodeInterval = setInterval(this.checkCodeStatus, this.interval * 1000, this);
                    // Todo: Don't check if window is not focused
                },
                getUsername: function () {
                    // Not implemented yet
                }
            }

            $("#SimklConfigurationPage").on("pageshow", function (e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(guid).then(function (config) {
                    $("#scr_pct").val(config.scr_pct);
                    $("#min_length").val(config.min_length);

                    $("#autoscrobble").checked(config.autoscrobble);
                    $("#bubble").checked(config.bubble);

                    if (config.userToken != "" && config.userToken != null) {
                        console.log("User is logged in with token " + config.userToken);
                        SimklAPI.user_code = config.userToken;
                        username = SimklAPI.getUsername();
                        $("#logOutButton").before("Hello again <here the username>!");
                        $("#loggedIn").show();
                    } else {
                        console.log("User is not logged in, showing pin and all the things");
                        $("#loginMsg").after("Please visit <a href='https://simkl.com/pin'>https://simkl.com/pin</a> on your phone or computer and enter the following code:");
                        SimklAPI.logIn("#loginPin");
                        $("#notLoggedIn").show();
                    }

                    Dashboard.hideLoadingMsg();
                });
            });

            $("#SimklConfigurationPage").on("submit", function (e) {
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(guid).then(function (config) {
                    config.scr_pct = $("#scr_pct").val();
                    config.min_length = $("#min_length").val();

                    ApiClient.updatePluginConfiguration(guid, config).then(Dashboard.processPluginConfigurationUpdateResult);
                    Dashboard.hideLoadingMsg();
                });

                // Don't do the 'default' submit
                return false;
            });
        </script>
    </div>
</body>
</html>