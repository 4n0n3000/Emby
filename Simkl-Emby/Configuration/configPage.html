<!DOCTYPE html>
<html>
<head>
    <title>Simkl's TV Tracker</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage" id="SimklConfigurationPage" data-require="emby-button,emby-checkbox,emby-input,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <h1>Simkl's TV Tracker</h1>
                <form id="SimklConfigurationForm">
                    <div id="selectContainer">
                        <select onchange="SimklConfig.onSelectorChange();" is="emby-select" id="user-selector" label="Showing plugin settings for...">
                            <!-- This will be populated by SimklConfig.populateUsers -->
                        </select>
                    </div>
                    <div id="loginButtonContainer">
                        <h3>It seems you are not logged in, do you wish to log in?</h3>
                        <button onclick="SimklConfig.startLoginProcess();" is="emby-button" type="button" class="raised button-submit block"><span>Log In</span></button>
                        <button onclick="location.href='https://simkl.com/';" is="emby-button" type="button" class="raised block"><span>Create an account</span></button>
                    </div>
                    <div id="loggingIn" hidden>
                        <h2>Logging In</h2>
                        <div id="loginText"></div>
                        <h3 id="loginPin"></h3>
                        <span id="loginSecondsRemaining">900</span> seconds remaining
                        <button onclick="SimklConfig.stopLoginProcess();" is="emby-button" type="button" class="raised button-cancel block"><span>Cancel</span></button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var SimklConfig = {
                guid: "2ecd91d5-b14b-4b92-8eb9-52c098edfc87",
                onLoginProccess: false,
                configCache: [],
                loginTimer: null,
                remainingTimer: null,
                finish: null,
                populateUsers : async function (users) {
                    users.forEach(function(user) {
                        $("#user-selector").append(new Option(user.Name, user.Id));
                    });
                },
                loadConfig : async function(user, config) {
                    if (config != null) this.configCache = config;
                    else config = this.configCache;

                    console.log("Simkl: Loading config for user " + user);
                    console.log(config);
                },
                startLoginProcess : async function () {
                    Dashboard.alert("Starting logging for user " + $("#user-selector").val());
                    this.onLoginProcess = true;

                    var code = SimklAPI.getCode();
                    this.finish = new Date();
                    this.finish.setSeconds(this.finish.getSeconds() + code.expires_in);
                    this.nextInterval = new Date();

                    this.loginTimer = window.setTimeout(this.checkLoginProcess.bind(this,code), code.interval*1000);
                    this.remainingTimer = window.setInterval(function() {
                        $("#loginSecondsRemaining").html(Math.round((SimklConfig.finish.getTime() - (new Date().getTime()))/1000));
                    } ,1000);

                    $("#loginText").html("Please visit <a href='" + code.verification_url + "/" + code.user_code +
                        "' target='_blank'>" + code.verification_url + "</a> on your phone or computer and enter the following code:");
                    $("#loginPin").html(code.user_code);

                    $("#loginButtonContainer").hide();
                    await $("#loggingIn").show();
                },
                checkLoginProcess : function (code) {
                    var response = SimklAPI.checkCode(code.user_code);
                    console.log("Response:");
                    console.log(response);

                    if (new Date() > this.finish) {
                        Dashboard.alert("Timed out!");
                        this.stopLoginProcess();
                    } else if (response.result == "KO") {
                        this.loginTimer = window.setTimeout(this.checkLoginProcess.bind(this,code), code.interval*1000);
                    } else if (response.result == "OK") {
                        this.stopLoginProcess();

                        // Save key on settings
                        var uguid = $("#user-selector").val();
                        var filter = this.configCache.userConfigs.filter(function(c) {
                            return c.guid == uguid;
                        });
                        if (filter.length > 0) {
                            filter[0].userToken = response.access_token;
                        } else {
                            this.configCache.userConfigs.push({
                                guid: uguid,
                                userToken: response.access_token
                            });
                        }

                        console.log(this.configCache);

                        ApiClient.updatePluginConfiguration(this.guid, this.configCache);
                    } else {
                        Dashboard.alert("Error logging in");
                    }
                },
                stopLoginProcess : async function () {
                    this.onLoginProcess = false;
                    window.clearTimeout(this.loginTimer);
                    window.clearInterval(this.remainingTimer);
                    $("#loginButtonContainer").show();
                    $("#loggingIn").hide();
                },
                onSelectorChange : async function () {
                    if (this.onLoginProcess) this.stopLoginProcess();
                    this.loadConfig($("#user-selector").val(), null);
                }
            }

            var SimklAPI = {
                getCode: function () {
                    var uri = "/Simkl/oauth/pin";
                    var request = new XMLHttpRequest();
                    request.open("GET", uri, false);
                    request.send();

                    if (request.status == 200) {
                        return $.parseJSON(request.response);
                    } else {
                        console.log(request);
                        Dashboard.alert("Some error occurred, see browser log for more details");
                        SimklConfig.stopLoginProcess();
                    }
                },
                checkCode : function (user_code) {
                    var uri = "/Simkl/oauth/pin/" + user_code;
                    var request = new XMLHttpRequest();
                    request.open("GET", uri, false);
                    request.send();

                    if (request.status == 200) {
                        return $.parseJSON(request.response);
                    } else {
                        console.log(request);
                        Dashboard.alert("Some error occurred, see browser log for more details");
                        SimklConfig.stopLoginProcess();
                    }
                }
            }

            $("#SimklConfigurationPage").on("pageshow", async function(e) {
                Dashboard.alert("WARNING: This is only a prototype, not currently working!");
                Dashboard.showLoadingMsg();
                await Promise.all([
                    ApiClient.getUsers().then(SimklConfig.populateUsers),
                    ApiClient.getPluginConfiguration(SimklConfig.guid).then(SimklConfig.loadConfig.bind(SimklConfig, ApiClient.getCurrentUserId()))]);
                Dashboard.hideLoadingMsg();
            });
        </script>
    </div>
</body>
</html>