<!DOCTYPE html>
<html>
<head>
    <title>Simkl</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage" id="SimklConfigurationPage" data-require="emby-button,emby-checkbox,emby-input,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <h1>Simkl's TV Tracker</h1>
                <form id="SimklConfigurationForm">
                    <div class="selectContainer">
                        <select is="emby-select" id="embyUser" onchange="SimklConfig.load(this.value);" label="Showing plugin Settings for:">
                            <!--<option value="">Select user</option>-->
                        </select>
                    </div>
                    <div id="notLoggedIn" hidden>
                        <h2>Log In</h2>
                        <h3 id="loginMsg">You are not logged in</h3>
                        <!-- TODO: Style this -->
                    </div>
                    <div id="loggedIn" hidden>
                        <h2>Log In</h2>
                        <button id="logOutButton" is="emby-button" type="button" class="raised block" onclick="SimklAPI.logOut();"><span>Log Out</span></button>
                    </div>
                    <div id="scrobblingOptions" hidden>
                        <h2>Scrobbling Options</h2>
                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="autoscrobble" />
                                <span>Enable autoscrobbling</span>
                            </label>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="bubble" />
                                <span>Show bubble while scrobbling</span>
                            </label>
                        </div>

                        <div class="inputContainer">
                            <input is="emby-input" id="scr_pct" type="number" min="0" max="100" pattern="[0-9]*" label="Scrobbling percentage:" />
                            <div class="fieldDescription">
                                Percentage watched needed to scrobble
                            </div>
                        </div>

                        <div class="inputContainer">
                            <input is="emby-input" id="min_length" type="number" min="0" max="60" pattern="[0-9]*" label="Min length:" />
                            <div class="fieldDescription">
                                Length needed (in minutes) for a clip to be scrobbled. This way, short videos and trailers won't be scrobbled
                            </div>
                        </div>
                        <br />
                        <br />
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>${ButtonSave}</span></button>
                        <button is="emby-button" type="button" onclick="history.back();" class="raised block"><span>${ButtonCancel}</span></button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var guid = "2ecd91d5-b14b-4b92-8eb9-52c098edfc87";
            var SimklConfig = {
                searchByGuid: function (userConfigs, userid) {
                    var index = -1;
                    for (var i = 0; index == -1 && i < userConfigs.length; i++) {
                        if (userConfigs[i].id == userid) index = i;
                    }
                    return index;
                },
                load: function (userId, page) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(guid).then(SimklConfig.show);
                },
                showLogIn: function (userConfig) {
                    SimklAPI.logIn("#notLoggedIn");
                    $("#notLoggedIn").show();
                },
                showLoggedIn: function (userConfig) {
                    $("#loggedIn").show();
                    $("#scrobblingOptions").show();
                },
                show: function (config) {
                    var userId = $("#embyUser").val();
                    var i = SimklConfig.searchByGuid(config.UserConfigs, userId);
                    var userConfig = config.UserConfigs[i];

                    console.log(i);
                    console.log(config);
                    console.log(userId);
                    console.log(userConfig);

                    if (i == -1) {
                        console.log("No config for " + userId + ", creating one");
                        config.UserConfigs[config.UserConfigs.length] = {id:userId};
                        ApiClient.updatePluginConfiguration(guid, config);
                        ApiClient.getPluginConfiguration(guid).then(SimklConfig.show);
                    } else {
                        if (userConfig.userToken == "" || userConfig.userToken == null) {
                            SimklConfig.showLogIn(userConfig);
                        } else {
                            SimklConfig.showLoggedIn(userConfig);
                        }
                    }

                    /*
                    $("#scr_pct").val(config.scr_pct);
                    $("#min_length").val(config.min_length);

                    $("#autoscrobble").checked(config.autoscrobble);
                    $("#bubble").checked(config.bubble);

                    if (config.userToken != "" && config.userToken != null) {
                        console.log("User is logged in with token " + config.userToken);
                        SimklAPI.user_code = config.userToken;
                        var config = SimklAPI.getUserSettings();
                        $("#logOutButton").before("Hello again " + config.user.name + "!");
                        $("#loggedIn").show();
                    } else {
                        console.log("User is not logged in, showing pin and all the things");
                        SimklAPI.logIn("#notLoggedIn");
                        $("#notLoggedIn").show();
                    }
                    */

                    Dashboard.hideLoadingMsg();
                },
                populateSelector: async function (users) {
                    users.forEach(function (user) {
                        $("#embyUser").append("<option value='" + user.Id + "'>" + user.Name + "</option>");
                    });
                }
            }

            var SimklAPI = {
                auth_pending:false,
                user_code: "",
                embyUserId: "",
                interval: 5,
                timeout: 500,
                access_token: "",
                chkCodeInterval: 0,
                verification_url: "",
                getCode: function () {
                    // var uri = ApiClient._serverAddress + "/Simkl/oauth/pin";
                    var uri = "/Simkl/oauth/pin";
                    var request = new XMLHttpRequest();

                    console.log("Getting " + uri);
                    request.open("GET", uri, false);
                    request.send();

                    console.log("Status: " + request.status);
                    console.log("Response: " + request.response);
                    var response = $.parseJSON(request.response);
                    this.user_code = response.user_code;
                    this.interval = response.interval + 1;
                    this.timeout = response.expires_in;
                    this.verification_url = response.verification_url;
                    this.auth_pending = true;

                    return request.status == 200;
                },
                checkCodeStatus: function (obj) {
                    if (!obj.auth_pending || new Date() > obj.finish) clearInterval(obj.chkCodeInterval);
                    else {
                        var uri = "/Simkl/oauth/pin/" + obj.user_code;
                        var r = new XMLHttpRequest();
                        r.open("GET", uri, false);
                        console.log("Getting " + uri);
                        r.send();   // Request sent

                        if (r.status == 200) {
                            var response = $.parseJSON(r.response);
                            obj.access_token = response.access_token;
                            obj.auth_pending = response.message == "Authorization pending";
                            console.log("Checking code status " + JSON.stringify(obj));
                            console.log("Response: " + JSON.stringify(response));

                            if(response.result == "OK") obj.setCodeInConfig();
                        }
                    }
                },
                setCodeInConfig: function () {
                    ApiClient.getPluginConfiguration(guid).then(function (config) {
                        config.UserConfigs[SimklConfig.searchByGuid($("#embyUser").val())].userToken = SimklAPI.access_token;

                        console.log("Saving access token in settings");
                        console.log(config);
                        ApiClient.updatePluginConfiguration(guid, config);
                    });
                },
                logIn: async function (div_id) {
                    this.getCode();
                    this.finish = new Date();
                    this.finish.setSeconds(this.finish.getSeconds() + this.timeout - 5 * this.interval)

                    // $(div_id).html(this.user_code);
                    $("#loginMsg").after("Please visit <a href='" + this.verification_url + "/" + this.user_code
                        + "' target='_blank'>" + this.verification_url + "</a> on your phone or computer and enter the following code:");
                    $(div_id).append('<h3 id="loginPin">' + this.user_code + '</h3>');
                    console.log("this: " + JSON.stringify(this));
                    this.chkCodeInterval = setInterval(this.checkCodeStatus, this.interval * 1000, this);
                    // Todo: Don't check if window is not focused
                },
                logOut: async function () {
                    this.user_code = "";
                    await this.setCodeInConfig();
                },
                getUserSettings: function () {
                    var uri = "/Simkl/users/settings";
                    var r = new XMLHttpRequest();
                    r.open("GET", uri, false);
                    r.send();

                    if (r.status == 200) {
                        return JSON.parse(r.response);
                    }
                }
            }

            $("#SimklConfigurationPage").on("pageshow", function (e) {
                Dashboard.showLoadingMsg();
                ApiClient.getUsers().then(SimklConfig.populateSelector);
                ApiClient.getPluginConfiguration(guid).then(SimklConfig.show);
            });

            $("#SimklConfigurationPage").on("submit", function (e) {
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(guid).then(function (config) {
                    config.scr_pct = $("#scr_pct").val();
                    config.min_length = $("#min_length").val();

                    ApiClient.updatePluginConfiguration(guid, config).then(Dashboard.processPluginConfigurationUpdateResult);
                    Dashboard.hideLoadingMsg();
                });

                // Don't do the 'default' submit
                return false;
            });
        </script>
    </div>
</body>
</html>